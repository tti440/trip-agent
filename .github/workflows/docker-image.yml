name: Docker Image CI/CD

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BASE: ${{ github.repository }}-base
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_APP: ${{ github.repository }}-app
  IMAGE_NAME_SPARK: ${{ github.repository }}-spark
  

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      base: ${{ steps.filter.outputs.base }}
      app: ${{ steps.filter.outputs.app }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      spark: ${{ steps.filter.outputs.spark }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            base:
              - 'docker/base.Dockerfile'
              - '.github/workflows/**'
            app:
              - 'src/api_backend.py'
              - 'src/api_app.py'
              - 'src/tools.py'
              - 'docker/app.Dockerfile'
            backend:
              - 'src/tools.py'
              - 'src/generation_pipeline.py'
              - 'src/graphrag_agent.py'
              - 'src/api_backend.py'
              - 'src/api_app.py'
              - 'docker/backend.Dockerfile'
            frontend:
              - 'src/app.py'
              - 'docker/frontend.Dockerfile'
            spark:
              - 'data_gather_src/**'
              - 'docker/spark.Dockerfile'

  build-base:
    needs: changes
    if: ${{ needs.changes.outputs.base == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Base
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/base.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ github.repository }}/myproject/base:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-services:
    needs: [changes, build-base]
    if: |
      always() && 
      (needs.changes.outputs.base == 'true' || 
       needs.changes.outputs.app == 'true' || 
       needs.changes.outputs.backend == 'true' || 
       needs.changes.outputs.frontend == 'true' || 
       needs.changes.outputs.spark == 'true')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: app
            run: ${{ needs.changes.outputs.app == 'true' || needs.changes.outputs.base == 'true' }}
            file: docker/app.Dockerfile
            tag: trip-app
          - service: backend
            run: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.base == 'true' }}
            file: docker/backend.Dockerfile
            tag: trip-backend
          - service: frontend
            run: ${{ needs.changes.outputs.frontend == 'true' || needs.changes.outputs.base == 'true' }}
            file: docker/frontend.Dockerfile
            tag: trip-frontend
          - service: spark
            run: ${{ needs.changes.outputs.spark == 'true' || needs.changes.outputs.base == 'true' }}
            file: docker/spark.Dockerfile
            tag: trip-spark
    steps:
      - uses: actions/checkout@v4
      - name: Build Service
        if: ${{ matrix.run == true }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.file }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.tag }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max